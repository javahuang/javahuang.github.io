
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>thread vs process · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc/page-toc.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="cpu-and-kernal.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../linux/">
            
                <a href="../linux/">
            
                    
                    Linux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../linux/linux-basis.html">
            
                <a href="../linux/linux-basis.html">
            
                    
                    linux basis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../linux/linux-filesystem.html">
            
                <a href="../linux/linux-filesystem.html">
            
                    
                    linux filesystem
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../linux/linux-commands.html">
            
                <a href="../linux/linux-commands.html">
            
                    
                    linux command
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../linux/linux-filesystem.html">
            
                <a href="../linux/linux-filesystem.html">
            
                    
                    linux filesystem
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../awesome/">
            
                <a href="../awesome/">
            
                    
                    Awesome
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../awesome/git.html">
            
                <a href="../awesome/git.html">
            
                    
                    git
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../awesome/gitbook.html">
            
                <a href="../awesome/gitbook.html">
            
                    
                    gitbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../docker/">
            
                <a href="../docker/">
            
                    
                    Docker
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../docker/docker-basis.html">
            
                <a href="../docker/docker-basis.html">
            
                    
                    docker basis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../docker/docker-swarm.html">
            
                <a href="../docker/docker-swarm.html">
            
                    
                    docker swarm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../docker/dockerfile.html">
            
                <a href="../docker/dockerfile.html">
            
                    
                    dockerfile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../docker/docker-composefile.html">
            
                <a href="../docker/docker-composefile.html">
            
                    
                    docker composefile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../docker/docker-practice.html">
            
                <a href="../docker/docker-practice.html">
            
                    
                    docker practice
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../html/">
            
                <a href="../html/">
            
                    
                    HTML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../javascript/">
            
                <a href="../javascript/">
            
                    
                    Javascript
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../javascript/canvas.html">
            
                <a href="../javascript/canvas.html">
            
                    
                    canvas
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../javascript/react/">
            
                <a href="../javascript/react/">
            
                    
                    react
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="../javascript/react/immer.html">
            
                <a href="../javascript/react/immer.html">
            
                    
                    immer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../javascript/tools/">
            
                <a href="../javascript/tools/">
            
                    
                    tools
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="../javascript/tools/babel.html">
            
                <a href="../javascript/tools/babel.html">
            
                    
                    babel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.2" data-path="../javascript/tools/gulp.html">
            
                <a href="../javascript/tools/gulp.html">
            
                    
                    gulp
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3.3" data-path="../javascript/tools/webpack.html">
            
                <a href="../javascript/tools/webpack.html">
            
                    
                    webpack
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../reading/">
            
                <a href="../reading/">
            
                    
                    Reading
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../reading/css-world.html">
            
                <a href="../reading/css-world.html">
            
                    
                    CSS 世界
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../reading/design-pattern-guru.html">
            
                <a href="../reading/design-pattern-guru.html">
            
                    
                    Design Pattern guru
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../reading/compilers.html">
            
                <a href="../reading/compilers.html">
            
                    
                    compilers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="./">
            
                <a href="./">
            
                    
                    Blog
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.8.1" data-path="thread-vs-process.html">
            
                <a href="thread-vs-process.html">
            
                    
                    thread vs process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="cpu-and-kernal.html">
            
                <a href="cpu-and-kernal.html">
            
                    
                    cpu and kernal
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="css-in-js.html">
            
                <a href="css-in-js.html">
            
                    
                    css in js
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="build-myself-developer-knowledgemap.html">
            
                <a href="build-myself-developer-knowledgemap.html">
            
                    
                    my knowledgemap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >thread vs process</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;&#x7684;&#x533A;&#x522B;">&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;&#x7684;&#x533A;&#x522B;</h1>
<p>&#x5185;&#x5B58;&#x600E;&#x4E48;&#x5206;&#x914D;&#xFF1F;&#x4EC0;&#x4E48;&#x662F;&#x5806;&#xFF0C;&#x4EC0;&#x4E48;&#x662F;&#x6808;&#xFF1F;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x9700;&#x8981;&#x54EA;&#x4E9B;&#x8D44;&#x6E90;&#xFF1F;&#x7EBF;&#x7A0B;&#x7684;&#x521B;&#x5EFA;&#x90FD;&#x9700;&#x8981;&#x54EA;&#x4E9B;&#x8D44;&#x6E90;&#xFF1F;</p>
<p>&#x5728; Linux &#x4E2D;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#xFF08;<code>fork</code>&#xFF09;&#x8FD8;&#x662F;&#x7EBF;&#x7A0B;&#xFF08;<code>pthread_create</code>&#xFF09;&#xFF0C;&#x6839;&#x672C;&#x4E0A;&#x662F; <a href="https://linux.die.net/man/2/clone" target="_blank">clone</a> &#x4E00;&#x4E2A;&#x5DF2;&#x5B58;&#x5728;&#x7684; task&#xFF08;&#x8FDB;&#x7A0B;|&#x7EBF;&#x7A0B;&#xFF09;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x4E8C;&#x8005;&#x7684;&#x5DEE;&#x522B;&#x5C31;&#x5728;&#x4E8E; clone &#x65F6; Flags &#x7684;&#x4F20;&#x9012;&#xFF0C;&#x5F53; <strong>CLONE_VM</strong> &#x4F4D;&#x8BBE;&#x7F6E;&#x65F6;&#xFF08;&#x5171;&#x4EAB;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF09;&#xFF0C;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#xFF1B;&#x5F53;&#x8BE5;&#x4F4D;&#x672A;&#x8BBE;&#x7F6E;&#x65F6;&#xFF0C;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x3002;
&#x5F53; <code>pthread_create</code> &#x4F20;&#x9012; <strong>CLONE_*</strong> Flags&#xFF0C;&#x544A;&#x8BC9;&#x5185;&#x6838;&#x4E0D;&#x9700;&#x8981;&#x62F7;&#x8D1D; the virtual memory image, the open files, the signal handlers &#x7B49;&#xFF0C;&#x53EF;&#x4EE5;&#x8282;&#x7701;&#x65F6;&#x95F4;&#x3002;
&#x4E0B;&#x9762;&#x6458;&#x81EA; <a href="https://eli.thegreenplace.net/2018/launching-linux-threads-and-processes-with-clone/" target="_blank">Launching Linux threads and processes with clone</a>&#xFF0C;&#x611F;&#x89C9;&#x7FFB;&#x8BD1;&#x7684;&#x8FD8;&#x662F;&#x6CA1;&#x6709;&#x76F4;&#x63A5;&#x8BFB;&#x539F;&#x6587;&#x6765;&#x7684;&#x987A; -_-||</p>
<blockquote>
<p>For processes, there&apos;s a bit of copying to be done when fork is invoked, which costs time. <strong>The biggest chunk of time</strong> probably goes to c<strong>opying the memory image</strong> due to the <strong>lack of CLONE_VM</strong>. Note, however, that it&apos;s not just copying the whole memory; Linux has an important optimization by using <strong>COW (Copy On Write) pages</strong>. <strong>The child&apos;s memory pages are initially mapped to the same pages shared by the parent, and only when we modify them the copy happens</strong>. This is very important because processes will often use a lot of shared read-only memory (think of the global structures used by the standard library, for example).</p>
</blockquote>
<p>&#x5982;&#x4E0B;&#x56FE;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x7EBF;&#x7A0B;&#x548C;&#x8FDB;&#x7A0B;&#x6240;&#x5360;&#x7528;&#x7684;&#x8D44;&#x6E90;&#xFF1A;</p>
<p><img src="../images/process-vs-thread.jpg" alt="process-vs-thread">
<em>&#x2014;&#x2014; Modern Operating Systems</em></p>
<p>&#x5728; Linux &#x4E2D;&#xFF0C;&#x5171;&#x4EAB;&#x5185;&#x5B58;&#x7684; task &#x53EF;&#x4EE5;&#x88AB;&#x770B;&#x505A;&#x662F;&#x540C;&#x4E00;&#x8FDB;&#x7A0B;&#x4E0B;&#x7684;&#x4E0D;&#x540C;&#x7EBF;&#x7A0B;&#x3002;&#x4ECE;&#x5185;&#x6838;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x8BB2;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; task &#x90FD;&#x5177;&#x6709;&#x4E00;&#x4E2A; PID(Process IDentifier)&#xFF0C;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#xFF0C;&#x540C;&#x4E00;&#x8FDB;&#x7A0B;&#x4E0B;&#x7684;&#x7EBF;&#x7A0B;&#x62E5;&#x6709;&#x4E0D;&#x540C;&#x7684; PID&#xFF01;&#x3002;
&#x6B64;&#x5916;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A; task &#x8FD8;&#x5177;&#x6709; TGID&#xFF08;Task Group ID)&#xFF0C;&#x540C;&#x4E00;&#x8FDB;&#x7A0B;&#x4E0B;&#x7684;&#x7EBF;&#x7A0B; TGID &#x76F8;&#x540C;&#xFF0C;&#x8FD9;&#x4E2A; TGID &#x5373;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x5E38;&#x610F;&#x4E49;&#x4E0B;&#x7684; PID&#x3002;</p>
<pre><code class="lang-text">                    User VIEW
 &lt;-- PID 43 --&gt; &lt;----------------- PID 42 -----------------&gt;
                     +---------+
                     | process |
                    _| pid=42  |_
                  _/ | tgid=42 | \_ (new thread) _
       _ (fork) _/   +---------+                  \
      /                                        +---------+
+---------+                                    | process |
| process |                                    | pid=44  |
| pid=43  |                                    | tgid=42 |
| tgid=43 |                                    +---------+
+---------+
 &lt;-- PID 43 --&gt; &lt;--------- PID 42 --------&gt; &lt;--- PID 44 ---&gt;
                     KERNEL VIEW
</code></pre>
<p>&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF0C;&#x5728;&#x7ECF;&#x5178;&#x7684;&#x8FDB;&#x7A0B;&#x3001;&#x7EBF;&#x7A0B;&#x6A21;&#x578B;&#x4E2D;&#xFF08;&#x652F;&#x6301; kernel-level threads &#x7684;&#x73B0;&#x4EE3; Unix&#xFF09;&#xFF1A;</p>
<ul>
<li><strong>&#x8FDB;&#x7A0B;&#x662F;&#x8D44;&#x6E90;&#x7684;&#x5BB9;&#x5668;&#xFF0C;&#x5305;&#x542B;&#xFF08;&#x4E00;&#x4E2A;&#x6216;&#xFF09;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#x3002;</strong></li>
<li><strong>&#x5185;&#x6838;&#x8C03;&#x5EA6;&#x7684;&#x57FA;&#x672C;&#x5355;&#x4F4D;&#x662F;&#x7EBF;&#x7A0B;&#x3001;&#x800C;&#x975E;&#x8FDB;&#x7A0B;&#x3002;</strong></li>
<li><strong>&#x540C;&#x4E00;&#x8FDB;&#x7A0B;&#x4E0B;&#x7684;&#x5404;&#x4E2A;&#x7EBF;&#x7A0B;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#xFF08;address space&#x3001;open files&#x3001;signal handlers&#xFF0C;etc&#xFF09;&#xFF0C;&#x4F46;&#x5BC4;&#x5B58;&#x5668;&#x3001;&#x6808;&#x3001;PC &#x7B49;&#x4E0D;&#x5171;&#x4EAB;;</strong></li>
</ul>
<h2 id="fork">fork</h2>
<p>fork &#x521B;&#x9020;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#x590D;&#x5236;&#x4E86;&#x7236;&#x8FDB;&#x7A0B;&#x7684; task_struct&#xFF0C;&#x7CFB;&#x7EDF;&#x5806;&#x6808;&#x7A7A;&#x95F4;&#x548C;&#x9875;&#x9762;&#x8868;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x4E0B;&#x9762;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x6267;&#x884C; count++&#x524D;&#xFF0C;&#x5176;&#x5B9E;&#x5B50;&#x8FDB;&#x7A0B;&#x548C;&#x7236;&#x8FDB;&#x7A0B;&#x7684; count &#x6307;&#x5411;&#x7684;&#x662F;&#x540C;&#x4E00;&#x5757;&#x5185;&#x5B58;&#x3002;&#x800C;&#x5F53;&#x5B50;&#x8FDB;&#x7A0B;&#x6539;&#x53D8;&#x4E86;&#x53D8;&#x91CF;&#x65F6;&#x5019;&#xFF08;&#x5373;&#x5BF9;&#x53D8;&#x91CF;&#x8FDB;&#x884C;&#x4E86;&#x5199;&#x64CD;&#x4F5C;&#xFF09;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7; copy_on_write &#x7684;&#x624B;&#x6BB5;&#x4E3A;&#x6240;&#x6D89;&#x53CA;&#x7684;&#x9875;&#x9762;&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x526F;&#x672C;&#x3002;</p>
<blockquote>
<p><strong>&#x5199;&#x5165;&#x65F6;&#x590D;&#x5236;(Copy-on-write)</strong> &#x662F;&#x4E00;&#x4E2A;&#x88AB;&#x4F7F;&#x7528;&#x5728;&#x7A0B;&#x5F0F;&#x8BBE;&#x8BA1;&#x9886;&#x57DF;&#x7684;&#x6700;&#x4F73;&#x5316;&#x7B56;&#x7565;&#x3002;&#x5176;&#x57FA;&#x7840;&#x7684;&#x89C2;&#x5FF5;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x591A;&#x4E2A;&#x547C;&#x53EB;&#x8005;(callers)&#x540C;&#x65F6;&#x8981;&#x6C42;&#x76F8;&#x540C;&#x8D44;&#x6E90;&#xFF0C;&#x4ED6;&#x4EEC;&#x4F1A;&#x5171;&#x540C;&#x53D6;&#x5F97;&#x76F8;&#x540C;&#x7684;&#x6307;&#x6807;&#x6307;&#x5411;&#x76F8;&#x540C;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x76F4;&#x5230;&#x67D0;&#x4E2A;&#x547C;&#x53EB;&#x8005;(caller)&#x5C1D;&#x8BD5;&#x4FEE;&#x6539;&#x8D44;&#x6E90;&#x65F6;&#xFF0C;&#x7CFB;&#x7EDF;&#x624D;&#x4F1A;&#x771F;&#x6B63;&#x590D;&#x5236;&#x4E00;&#x4E2A;&#x526F;&#x672C;(private copy)&#x7ED9;&#x8BE5;&#x547C;&#x53EB;&#x8005;&#xFF0C;&#x4EE5;&#x907F;&#x514D;&#x88AB;&#x4FEE;&#x6539;&#x7684;&#x8D44;&#x6E90;&#x88AB;&#x76F4;&#x63A5;&#x5BDF;&#x89C9;&#x5230;&#xFF0C;&#x8FD9;&#x8FC7;&#x7A0B;&#x5BF9;&#x5176;&#x4ED6;&#x7684;&#x547C;&#x53EB;&#x53EA;&#x90FD;&#x662F;&#x901A;&#x900F;&#x7684;(transparently)&#x3002;&#x6B64;&#x4F5C;&#x6CD5;&#x4E3B;&#x8981;&#x7684;&#x4F18;&#x70B9;&#x662F;&#x5982;&#x679C;&#x547C;&#x53EB;&#x8005;&#x5E76;&#x6CA1;&#x6709;&#x4FEE;&#x6539;&#x8BE5;&#x8D44;&#x6E90;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x6709;&#x526F;&#x672C;(private copy)&#x88AB;&#x5EFA;&#x7ACB;&#x3002;</p>
</blockquote>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span>  // &#x63D0;&#x4F9B;&#x6253;&#x5370;&#x8BED;&#x53E5;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span> // &#x63D0;&#x4F9B;EXIT_SUCCESS</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span> // &#x63D0;&#x4F9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">int</span> count = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">int</span> child;

    child = fork();
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, getpid());
    <span class="hljs-keyword">if</span> (child &lt; <span class="hljs-number">0</span>)
    {
        perror(<span class="hljs-string">&quot;fork error : &quot;</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child == <span class="hljs-number">0</span>)
    {
        <span class="hljs-comment">// This is father, his count is: 1 (0x7fff8f49d6a8), his pid is: 7</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is son, his count is: %d (%p). and his pid is: %d\n&quot;</span>, ++count, &amp;count, getpid());
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// This is son, his count is: 2 (0x7fff8f49d6a8). and his pid is: 8</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is father, his count is: %d (%p), his pid is: %d\n&quot;</span>, count, &amp;count, getpid());
    }

    <span class="hljs-keyword">return</span> EXIT_SUCCESS;
}
</code></pre>
<p>exec &#x7528;&#x4E00;&#x6BB5;&#x65B0;&#x7684;&#x7A0B;&#x5E8F;&#x6765;&#x66FF;&#x4EE3;&#x6574;&#x4E2A;&#x8FDB;&#x7A0B;&#xFF0C;fork &#x901A;&#x5E38;&#x548C; exec &#x4E00;&#x8D77;&#x4F7F;&#x7528;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#x3002;
&#x76F4;&#x63A5; fork &#x7684;&#x8BDD;&#x5B50;&#x8FDB;&#x7A0B;&#x4F1A;&#x548C;&#x7236;&#x8FDB;&#x7A0B;&#x5171;&#x4EAB;&#x76F8;&#x540C;&#x7684;&#x4EE3;&#x7801;&#x6BB5;&#xFF0C;&#x5982;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5B50;&#x8FDB;&#x7A0B;&#x4E5F;&#x4F1A;&#x5C06;&#x6574;&#x4E2A;&#x4EE3;&#x7801;&#x6BB5;&#x6267;&#x884C;&#x4E00;&#x904D;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span> // correct header</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span> // &#x63D0;&#x4F9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</span>

<span class="hljs-keyword">char</span> command[<span class="hljs-number">256</span>];

<span class="hljs-comment">// docker run --rm -v &quot;$PWD&quot;:/usr/src/myapp -w /usr/src/myapp gcc gcc -o myapp exec.c</span>
<span class="hljs-comment">// docker run -it --rm -v &quot;$PWD&quot;:/usr/src/myapp -w /usr/src/myapp gcc sh -c &quot;./myapp&quot;</span>
<span class="hljs-comment">// &#x5982;&#x679C;&#x6CA1;&#x6709; exec&#xFF0C;&#x76F4;&#x63A5; fork&#xFF0C;&#x7236;&#x5B50;&#x8FDB;&#x7A0B;&#x5171;&#x7528;&#x4EE3;&#x7801;&#x6BB5;&#xFF0C;&#x4F1A;&#x6267;&#x884C;&#x4E00;&#x6837;&#x7684;&#x4EE3;&#x7801;</span>
<span class="hljs-comment">// &#x5982;&#x679C;&#x5728; fork &#x91CC;&#x9762;&#x63A5;&#x7740;&#x8C03;&#x7528; exec&#xFF0C;&#x5219;&#x5B50;&#x8FDB;&#x7A0B;&#x53EA;&#x4F1A;&#x6267;&#x884C; exec &#x91CC;&#x9762;&#x7684;&#x4EE3;&#x7801;</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> rtn; <span class="hljs-comment">/*&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x8FD4;&#x56DE;&#x6570;&#x503C;*/</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)
    {
        <span class="hljs-comment">/* &#x4ECE;&#x7EC8;&#x7AEF;&#x8BFB;&#x53D6;&#x8981;&#x6267;&#x884C;&#x7684;&#x547D;&#x4EE4; */</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&quot;</span>);
        fgets(command, <span class="hljs-number">256</span>, <span class="hljs-built_in">stdin</span>);
        command[<span class="hljs-built_in">strlen</span>(command) - <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (fork() == <span class="hljs-number">0</span>)
        { <span class="hljs-comment">/* &#x5B50;&#x8FDB;&#x7A0B;&#x6267;&#x884C;&#x6B64;&#x547D;&#x4EE4; */</span>
            <span class="hljs-comment">// https://unix.stackexchange.com/questions/187666/why-do-we-have-to-pass-the-file-name-twice-in-exec-functions</span>
            <span class="hljs-comment">// &#x5FC5;&#x987B;&#x4F20;&#x9012;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4F5C;&#x4E3A; argv[0]</span>
            execlp(command, <span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-literal">NULL</span>);
            <span class="hljs-comment">/* &#x5982;&#x679C;exec&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#xFF0C;&#x8868;&#x660E;&#x6CA1;&#x6709;&#x6B63;&#x5E38;&#x6267;&#x884C;&#x547D;&#x4EE4;&#xFF0C;&#x6253;&#x5370;&#x9519;&#x8BEF;&#x4FE1;&#x606F;*/</span>
            perror(command);
            <span class="hljs-built_in">exit</span>(errno);
        }
        <span class="hljs-keyword">else</span>
        { <span class="hljs-comment">/* &#x7236;&#x8FDB;&#x7A0B;&#xFF0C; &#x7B49;&#x5F85;&#x5B50;&#x8FDB;&#x7A0B;&#x7ED3;&#x675F;&#xFF0C;&#x5E76;&#x6253;&#x5370;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x8FD4;&#x56DE;&#x503C; */</span>
            wait(&amp;rtn);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; child process return %d\n&quot;</span>, rtn);
        }
    }
    <span class="hljs-keyword">return</span> EXIT_SUCCESS;
}
</code></pre>
<h2 id="clone">clone</h2>
<p>clone() is the syscall used by fork(). with some parameters, it creates a new process, with others, it creates a thread. the difference between them is just which data structures (memory space, processor state, stack, PID, open files, etc) are shared or not.</p>
<pre><code class="lang-c">/* pid_t *parent_tid, void *tls, pid_t *child_tid */
int clone(int (*fn)(void *), void *stack, int flags, void *arg)
</code></pre>
<ul>
<li><code>fn</code> &#x51FD;&#x6570;&#x6307;&#x9488;&#xFF0C;clone &#x9700;&#x8981;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#x6765;&#x8FD0;&#x884C;</li>
<li><code>stack</code> &#x7528;&#x6765;&#x8BBE;&#x7F6E;&#x521B;&#x5EFA;&#x7684; task &#x7684; stack &#x5927;&#x5C0F;</li>
<li><code>flags</code><ul>
<li><strong>SIGCHLD</strong> &#x5B50; process &#x7EC8;&#x6B62;&#x65F6;&#xFF0C;&#x5E94;&#x8BE5;&#x53D1;&#x9001; SIGCHLD &#x4FE1;&#x53F7;&#x7ED9;&#x7236; process</li>
<li><strong>CLONE_VM</strong> &#x7236;&#x5B50; process</li>
</ul>
</li>
<li><code>arg</code> &#x4F20;&#x9012;&#x7ED9;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x53C2;&#x6570;</li>
</ul>
<h3 id="&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;">&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;</h3>
<p>&#x9664;&#x4E86;&#x4F7F;&#x7528; <code>fork</code> &#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528; clone&#x3002;</p>
<p><strong>Modern Unix design</strong>&#xFF1A;</p>
<ul>
<li><strong>Copy On Write</strong>: Allow both the parent and the child to <strong>read the same physical pages</strong>. Whenever either one tries to write on a physical page, the kernel copies its contents into a new physical page that is assigned to the writing process.</li>
<li><strong>Lightweight process</strong>: Allow both the parent and the child to share many per-process kernel data structures, such as <em>the paging tables</em> (and therefore <em>the entire User Mode address space</em>), <em>the open file table</em>s, and <em>the signal dispositions</em>.</li>
<li><strong>vfork() system call</strong>: Create a process that shares the memory address space of its parent. To prevent the parent from overwriting data needed by the child, the parent&#x2019;s execution is blocked until the child exits or executes a new program.</li>
</ul>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sched.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fn</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span>
</span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nINFO: This code is running under child process.\n&quot;</span>);
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> n = atoi(arg);
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++)
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d * %d = %d\n&quot;</span>, n, i, (n * i));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello, World!\n&quot;</span>);

    <span class="hljs-keyword">void</span> *pchild_stack = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);
    <span class="hljs-keyword">if</span> (pchild_stack == <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ERROR: Unable to allocate memory.\n&quot;</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }
    <span class="hljs-comment">// &#x7EBF;&#x7A0B;&#x5206;&#x914D;&#x7684;&#x6808;&#x5927;&#x5C0F;</span>
    <span class="hljs-keyword">int</span> pid = clone(fn, pchild_stack + (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>), SIGCHLD, argv[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ERROR: Unable to create the child process.\n&quot;</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    wait(<span class="hljs-literal">NULL</span>);
    <span class="hljs-built_in">free</span>(pchild_stack);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INFO: Child process terminated.\n&quot;</span>);
}
</code></pre>
<h3 id="&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;">&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;</h3>
<p>linux &#x521B;&#x5EFA;&#x7684; threads&#xFF0C;&#x5E95;&#x5C42;&#x5176;&#x5B9E;&#x662F;&#x7CFB;&#x7EDF;&#x8C03;&#x7528; <a href="https://linux.die.net/man/2/clone" target="_blank">clone</a> &#x4EA7;&#x751F;&#x7684; child processes&#x3002;&#x7EBF;&#x7A0B;&#x4E5F;&#x6709;&#x81EA;&#x5DF1;&#x7684; pid&#xFF08;&#x5176;&#x5B9E;&#x79F0;&#x4E4B;&#x4E3A; TID &#x540E;&#x8005; thread ID &#x66F4;&#x597D;&#xFF09;&#xFF0C;&#x7EBF;&#x7A0B;&#x548C;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#x7684;&#x8FDB;&#x7A0B;&#x6709;&#x76F8;&#x540C;&#x7684; TGID&#xFF08;task group id&#xFF09;&#x3002;
TGID &#x548C;&#x8FDB;&#x7A0B; ID &#x76F8;&#x540C;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x53EF;&#x4EE5;&#x7ED9;&#x8FDB;&#x7A0B;&#x548C;&#x91CC;&#x9762;&#x7684;&#x7EBF;&#x7A0B;&#x90FD;&#x79F0;&#x4E4B;&#x4E3A; task&#xFF0C;&#x8FDB;&#x7A0B;&#x662F; main task&#xFF0C;&#x4ED6;&#x4EEC;&#x62E5;&#x6709;&#x76F8;&#x540C;&#x7684; TGID&#xFF0C;<strong>&#x5185;&#x6838;&#x8C03;&#x5EA6;&#x7684;&#x57FA;&#x672C;&#x5355;&#x4F4D;&#x662F;&#x7EBF;&#x7A0B;&#x800C;&#x975E;&#x8FDB;&#x7A0B;&#xFF0C;&#x8FDB;&#x7A0B;&#x53EA;&#x9700;&#x8981;&#x8D1F;&#x8D23;&#x7BA1;&#x7406;&#x8D44;&#x6E90;&#xFF0C;&#x8FD9;&#x4E9B;&#x8D44;&#x6E90;&#x7531;&#x540C;&#x4E00;&#x8FDB;&#x7A0B;&#x4E0B;&#x7684;&#x7EBF;&#x7A0B;&#x5171;&#x4EAB;</strong>&#x3002;
&#x7EBF;&#x7A0B;&#x4E5F;&#x53EB; Lightweight process&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>ps -L -p progress_id</code> &#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x8FDB;&#x7A0B;&#x91CC;&#x9762;&#x7684;&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#x3002;
&#x4E0B;&#x56FE;&#x662F;&#x901A;&#x8FC7; <code>htop -p 5012</code> &#x67E5;&#x770B;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;&#x3002;</p>
<p><img src="../images/htop-of-clone-thread.jpg" alt="htop-of-clone-thread"></p>
<p>&#x4E0B;&#x9762;&#x662F;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#x65F6;&#xFF0C;&#x4F20;&#x9012;&#x7ED9; clone &#x7684;&#x53C2;&#x6570;&#xFF1A;</p>
<ul>
<li>CLONE_THREAD the child is placed in the same thread group as the calling process.</li>
<li>CLONE_SIGHAND he calling process and the child process share the same table of signal handlers.</li>
<li>CLONE_FS the caller and the child process share the same file system information</li>
<li>CLONE_VM the calling process and the child process run in the same memory space</li>
<li>CLONE_FILES the calling process and the child process share the same file descriptor table.</li>
</ul>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _SCHED_H 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __USE_GNU 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bits/sched.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STACK_SIZE 4096</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span>
</span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Inside func.\n&quot;</span>);
    sleep(<span class="hljs-number">200</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Terminating func...\n&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// getpid() &#x8FD4;&#x56DE;&#x7684;&#x662F; TGID</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This process pid: %u\n&quot;</span>, getpid());
    <span class="hljs-keyword">char</span> status_file[] = <span class="hljs-string">&quot;/proc/self/status&quot;</span>;
    <span class="hljs-keyword">void</span> *child_stack = <span class="hljs-built_in">malloc</span>(STACK_SIZE);
    <span class="hljs-keyword">int</span> thread_pid;

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Creating new thread...\n&quot;</span>);
    <span class="hljs-comment">// &#x521B;&#x5EFA;&#x7EBF;&#x7A0B;</span>
    thread_pid = clone(&amp;func, child_stack + STACK_SIZE, CLONE_SIGHAND | CLONE_FS | CLONE_VM | CLONE_FILES | CLONE_THREAD, <span class="hljs-literal">NULL</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Done! Thread pid: %d\n&quot;</span>, thread_pid);

    FILE *fp = fopen(status_file, <span class="hljs-string">&quot;rb&quot;</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Looking into %s...\n&quot;</span>, status_file);

    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)
    {
        <span class="hljs-keyword">char</span> ch = fgetc(fp);
        <span class="hljs-keyword">if</span> (feof(fp))
            <span class="hljs-keyword">break</span>;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c&quot;</span>, ch);
    }

    fclose(fp);
    getchar();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 id="stack-vs-heap">Stack vs Heap</h2>
<p>The memory that is assigned to a program or application in a computer can be divided into five parts. The amount of memory that get&#x2019;s assigned to an application depends on the computer&#x2019;s architecture and will vary across most devices, but the variable that remains constant is the five parts of an application&#x2019;s memory which are the <strong>heap</strong>, <strong>stack</strong>, <strong>initialized data segment</strong>, <strong>uninitialized data segment</strong>, and the <strong>text segment</strong>.</p>
<p><img src="../images/five-segments-of-memory.jpeg" alt="five-segments-of-memory"></p>
<ul>
<li><em>text segment</em> &#x53C8;&#x79F0;&#x4EE3;&#x7801;&#x6BB5;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4EE3;&#x7801;&#x7F16;&#x8BD1;&#x6210;&#x7684;&#x673A;&#x5668;&#x6307;&#x4EE4;&#xFF0C;&#x901A;&#x5E38;&#x662F;&#x53EA;&#x8BFB;&#x7684;</li>
<li><em>initialized data segment</em> &#x5305;&#x542B;&#x6240;&#x6709;&#x7684;&#x5168;&#x5C40;&#x548C;&#x9759;&#x6001;&#x53D8;&#x91CF;</li>
<li><em>uninitialized data segment</em> &#x5305;&#x542B;&#x6240;&#x6709;&#x88AB;&#x521D;&#x59CB;&#x5316;&#x4E3A;&#x96F6;&#x503C;&#x7684;&#x5168;&#x5C40;&#x548C;&#x9759;&#x6001;&#x53D8;&#x91CF;</li>
<li><p>The <em>stack</em> is a segment of memory where data like your local variables and function calls get added and/or removed in a last-in-first-out (<strong>LIFO</strong>) manner.</p>
<ul>
<li>The main function and all the local variables are stored in an initial frame. <code>main()</code> &#x65B9;&#x6CD5;&#x548C;&#x6240;&#x6709;&#x7684;&#x672C;&#x5730;&#x53D8;&#x91CF;&#x5B58;&#x653E;&#x5728;&#x521D;&#x59CB;&#x6808;&#x5E27;&#x91CC;&#x9762;</li>
</ul>
<p><img src="../images/program-vs-stack-usage.jpeg" alt="program-vs-stack-usage"></p>
<ul>
<li>&#x5728;&#x7A0B;&#x5E8F;&#x91CC;&#x9762;&#x8FDB;&#x884C;&#x591A;&#x6B21;&#x51FD;&#x6570;&#x8C03;&#x7528;&#xFF0C;&#x4F1A;&#x751F;&#x6210;&#x591A;&#x4E2A; stack frames&#x3002;Every time a new stack frame is created, the stack pointer moves with it until it reaches the terminating condition.&#x5728;&#x9012;&#x5F52;&#x8C03;&#x7528;&#x91CC;&#x9762;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7ED3;&#x675F;&#x6807;&#x8BC6;&#xFF0C;&#x5F88;&#x5FEB;&#x5C31;&#x4F1A;&#x51FA;&#x73B0; <em>stack overflow</em>&#x3002;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <strong>ulimit -a</strong> &#x67E5;&#x770B;&#x6808;&#x7684;&#x6700;&#x5927;&#x503C;</li>
</ul>
<p><img src="../images/program-vs-multi-stack.jpeg" alt="program-vs-multi-stack"></p>
</li>
<li><p><em>heap</em> &#x901A;&#x8FC7; <code>malloc()</code> &#x8C03;&#x7528;&#x4ECE;&#x5806;&#x4E0A;&#x5206;&#x914D;&#x5185;&#x5B58;&#xFF0C;&#x53C2;&#x89C1; <a href="cpu-kernel">&#x5185;&#x5B58;&#x7AE0;&#x8282;&#x53C2;&#x89C1; CPU &#x548C; Kernal &#x5185;&#x5B58;</a> &#x4E00;&#x8282;&#x3002;&#x64CD;&#x4F5C;&#x5806;&#x7684;&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x6709; <a href="https://linux.die.net/man/3/malloc" target="_blank">malloc</a>&#x3001;realloc&#x3001;calloc &#x548C; free&#x3002;</p>
<blockquote>
<p>The heap is the segment of memory that is not set to a constant size before compilation and can be controlled dynamically by the programmer. Think of the heap as a &#x201C;free pool&#x201D; of memory you can use when running your application. The size of the heap for an application is determined by the physical constraints of your RAM (Random access memory) and is generally much larger in size than the stack.</p>
</blockquote>
</li>
</ul>
<p><img src="../images/heap-vs-stack.jpeg" alt="heap-vs-stack"></p>
<p><a href="http://www.cs.uwm.edu/classes/cs315/Bacon/Lecture/HTML/ch10s07.html" target="_blank">&#x4EC0;&#x4E48;&#x662F; Stack Frame?</a></p>
<p>The stack frame, also known as activation record is the collection of all data on the stack associated with one subprogram call.</p>
<h2 id="proc">/proc</h2>
<p><code>/proc</code> &#x662F;&#x4E00;&#x4E2A;&#x865A;&#x62DF;&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#x3002;This special directory holds all the details about your Linux system, including its <strong>kernel</strong>, <strong>processes</strong>, and c<strong>onfiguration parameters</strong>. Although <strong>almost all the files are read-only</strong>, <strong>a few writable ones (notably in /proc/sys)</strong> allow you to change kernel parameters.</p>
<p><img src="../images/linux-proc.jpg" alt="linux-proc"></p>
<ul>
<li><code>/proc/meminfo</code> &#x83B7;&#x53D6;&#x5185;&#x5B58;&#x4FE1;&#x606F;</li>
<li><code>/proc/cpuinfo</code> &#x83B7;&#x53D6; cpu &#x4FE1;&#x606F;</li>
<li><code>/proc/version</code> &#x83B7;&#x53D6;&#x5185;&#x6838;&#x7248;&#x672C;</li>
<li><code>/proc/devices</code> Displays all currently configured and loaded character and block devices.</li>
<li><code>/proc/mounts</code> Shows all the mounts used by your machine (its output looks much like /etc/mtab)</li>
<li><code>/proc/self/</code> &#x8868;&#x793A;&#x5F53;&#x524D;&#x6253;&#x5F00;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x5728;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>/proc/self</code> &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;&#x3002;</li>
<li><code>/proc/&lt;number&gt;/</code> number &#x8868;&#x793A;&#x8FDB;&#x7A0B; PID</li>
</ul>
<h3 id="&#x8FDB;&#x7A0B;">&#x8FDB;&#x7A0B;</h3>
<p>&#x4E0B;&#x9762;&#x4EE5;&#x6211;&#x672C;&#x673A;&#x542F;&#x52A8;&#x7684;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x6765;&#x8BE6;&#x7EC6;&#x7684;&#x4ECB;&#x7ECD; /proc &#x8FD9;&#x4E2A;&#x76EE;&#x5F55;</p>
<p><img src="../images/proc-1183.jpg" alt="proc-1183"></p>
<pre><code class="lang-bash">[root@localhost cwd]<span class="hljs-comment"># lsof -p 1183</span>
COMMAND  PID USER   FD      TYPE    DEVICE SIZE/OFF     NODE NAME
main    1183 root  cwd       DIR       8,3     4096 31064716 /srv/cdts/survey-service/bin
main    1183 root  rtd       DIR       8,3     4096        2 /
main    1183 root  txt       REG       8,3 15937112 31081887 /srv/cdts/survey-service/bin/main
main    1183 root    0u      CHR     136,4      0t0        7 /dev/pts/4 (deleted)
main    1183 root    1u      CHR     136,4      0t0        7 /dev/pts/4 (deleted)
main    1183 root    2u      CHR     136,4      0t0        7 /dev/pts/4 (deleted)
main    1183 root    3u     IPv6 622084018      0t0      TCP *:avt-profile-2 (LISTEN)
main    1183 root    4u  a_inode      0,10        0     8330 [eventpoll]
main    1183 root    5u     IPv6 622084094      0t0      TCP localhost.localdomain:avt-profile-2-&gt;localhost.localdomain:33862 (ESTABLISHED)
</code></pre>
<ul>
<li><strong>cwd</strong> &#x6307;&#x5411;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x8FD0;&#x884C;&#x76EE;&#x5F55;&#x7684;&#x7B26;&#x53F7;&#x94FE;&#x63A5;&#xFF0C;&#x5BF9;&#x5E94;&#x4E0A;&#x9762;&#x7B2C;&#x4E00;&#x884C;</li>
<li><strong>cmdline</strong> &#x542F;&#x52A8;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x5B8C;&#x6574;&#x547D;&#x4EE4;&#xFF0C;&#x5BF9;&#x5E94;&#x4E0A;&#x9762;&#x7B2C;&#x4E09;&#x884C;</li>
<li><strong>fd</strong> &#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x6253;&#x5F00;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x5BF9;&#x5E94;&#x4E0A;&#x9762;&#x7684; FD &#x4ECE; 0u &#x5F00;&#x59CB;</li>
<li><strong>environ</strong> &#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x5217;&#x8868;</li>
<li><strong>exe</strong> &#x6307;&#x5411;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;&#x7B26;&#x53F7;&#x94FE;&#x63A5;</li>
<li><strong>limits</strong> &#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x4F7F;&#x7528;&#x7684;&#x8D44;&#x6E90;&#x9650;&#x5236;</li>
<li><strong>status</strong> &#x4E0E; stat &#x63D0;&#x4F9B;&#x7684;&#x4FE1;&#x606F;&#x7C7B;&#x4F3C;&#xFF0C;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;</li>
<li><strong>statm</strong> &#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x5360;&#x7528;&#x5185;&#x5B58;&#x72B6;&#x6001;&#x4FE1;&#x606F;</li>
<li><strong>task</strong> &#x76EE;&#x5F55;&#x6587;&#x4EF6;&#xFF0C;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x8FD0;&#x884C;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#xFF0C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x4FDD;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x7531;&#x7EBF;&#x7A0B;&#x53F7;&#x547D;&#x540D;&#x7684;&#x76EE;&#x5F55;&#x4E2D;</li>
</ul>
<h2 id="&#x53C2;&#x8003;">&#x53C2;&#x8003;</h2>
<p><a href="https://medium.com/@nickteixeira/stack-vs-heap-whats-the-difference-and-why-should-i-care-5abc78da1a88" target="_blank">Stack vs Heap. What&#x2019;s the difference and why should I care?</a></p>
<p><a href="https://eli.thegreenplace.net/2018/launching-linux-threads-and-processes-with-clone/" target="_blank">Launching Linux threads and processes with clone</a></p>
<p><a href="https://stackoverflow.com/questions/9305992/if-threads-share-the-same-pid-how-can-they-be-identified" target="_blank">If threads share the same PID, how can they be identified?</a></p>
<p><a href="https://www.zhihu.com/question/44087187/answer/136188761" target="_blank">&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;&#x4E4B;&#x95F4;&#x6709;&#x4EC0;&#x4E48;&#x6839;&#x672C;&#x6027;&#x7684;&#x533A;&#x522B;&#xFF1F; - &#x5F20;&#x6797;&#x660A;&#x7684;&#x56DE;&#x7B54; - &#x77E5;&#x4E4E;</a></p>
<p><a href="https://www.zhihu.com/question/25532384" target="_blank">&#x7EBF;&#x7A0B;&#x548C;&#x8FDB;&#x7A0B;&#x7684;&#x533A;&#x522B;</a></p>
<p><a href="...">&#x672C;&#x6587; code</a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: Blog">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="cpu-and-kernal.html" class="navigation navigation-next " aria-label="Next page: cpu and kernal">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"thread vs process","date":"2018-08-23T00:00:00.000Z","permalink":"linux-process-vs-thread","categories":["代码"],"tags":["linux"],"toc":true,"level":"1.8.1","depth":2,"next":{"title":"cpu and kernal","level":"1.8.2","depth":2,"path":"post/cpu-and-kernal.md","ref":"post/cpu-and-kernal.md","articles":[]},"previous":{"title":"Blog","level":"1.8","depth":1,"path":"post/README.md","ref":"post/README.md","articles":[{"title":"thread vs process","level":"1.8.1","depth":2,"path":"post/thread-vs-process.md","ref":"post/thread-vs-process.md","articles":[]},{"title":"cpu and kernal","level":"1.8.2","depth":2,"path":"post/cpu-and-kernal.md","ref":"post/cpu-and-kernal.md","articles":[]},{"title":"css in js","level":"1.8.3","depth":2,"path":"post/css-in-js.md","ref":"post/css-in-js.md","articles":[]},{"title":"my knowledgemap","level":"1.8.4","depth":2,"path":"post/build-myself-developer-knowledgemap.md","ref":"post/build-myself-developer-knowledgemap.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["page-toc"],"pluginsConfig":{"page-toc":{"selector":".markdown-section h1, .markdown-section h2, .markdown-section h3, .markdown-section h4","position":"before-first","showByDefault":true},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"post/thread-vs-process.md","mtime":"2020-09-25T05:48:12.835Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-10-10T05:26:35.110Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/anchor-3.1.1.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-page-toc/page-toc.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

